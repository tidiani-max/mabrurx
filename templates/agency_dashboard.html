<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agency Dashboard - MabrurX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Diadopsi dari beranda MabrurX
                        primary: '#1E3A8A', // Blue-800/900 for the main color
                        accent: '#FBBF24',  // Yellow-500/400 for highlights
                        neutral: '#4B5563', // Gray for text
                        light: '#F9FAFB', // Light background
                        success: '#10B981', // Green for success/low risk
                        warning: '#F59E0B', // Orange for pending/medium risk
                        danger: '#EF4444',  // Red for high risk/deceased
                        official: '#7C3AED', // Added for clarity (Government document)
                        tracker: '#3B82F6', // Blue-500 for the new tracker feature
                        // Tambahan warna untuk laporan formal
                        secondary: '#D97706', // Orange-700, used as a strong accent line
                        // Tambahan untuk sertifikat
                        certbg: '#F0FFF4', // Green-50 for background
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Memastikan modal berada di atas segalanya */
        #detailModal, #kpiModal, #documentModal, #reportModal { z-index: 1000; }
        /* Scrollbar kustom */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }

        /* Styling for Report View to match formal government-style design */
        .report-header-formal {
            border-bottom: 3px solid #D97706; /* secondary */
            padding-bottom: 1rem;
        }
        .report-table th {
            background-color: #f3f4f6; /* gray-50 */
        }
        .report-table tr:nth-child(even) {
            background-color: #f9fafb; /* light */
        }

        /* Print-specific styles for the modal */
        @media print {
            body > *:not(#documentModal, #reportModal) {
                display: none !important; /* Hide everything except the modals meant for printing */
            }
            /* General print setup for both report and document */
            #reportModal, #documentModal {
                position: static !important;
                display: block !important;
                background-color: white !important;
                height: auto !important;
                width: 100% !important;
                max-height: none !important; /* Allow full height when printing */
            }
            /* Hide non-printable elements */
            .no-print, .no-print-doc {
                display: none !important;
            }

            /* Report-specific print styles */
            #reportModal .max-w-7xl {
                max-width: 100% !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                height: auto !important;
            }
            .report-header-formal, .report-table {
                box-shadow: none !important;
            }
            
            /* Document/Certificate-specific print styles */
            #documentModal .max-w-2xl { 
                max-width: 100% !important; 
                width: 100% !important; 
                margin: 0 !important; 
            }
            #certPreview { 
                box-shadow: none !important; 
                border: none !important; /* Remove dashed border in print */
            }
             #documentModal .p-6.flex-grow.overflow-y-auto {
                padding: 0;
                background-color: white !important;
             }
        }
    </style>
</head>
<body class="bg-light font-sans antialiased">

    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-primary">Mabrur<span class="text-accent">X</span></h1>
                    <span class="ml-4 text-neutral font-medium">Dasbor Agensi</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="#" class="text-primary font-semibold">Dasbor</a>
                    <a href="/register_Pilgrim_form/" class="text-neutral hover:text-primary">Daftar Jemaah</a> 
                    <a href="/laporan/new" class="text-neutral hover:text-primary">Lapor Kematian</a>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-user-tie text-primary text-xl"></i>
                        <span class="text-neutral font-semibold">Admin IBRI-Travel</span>
                        <a href="/login" class="bg-accent text-gray-900 px-3 py-1 rounded-md text-sm hover:bg-yellow-600 transition">Keluar</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8 flex justify-between items-center">
            <h2 class="text-3xl font-bold text-gray-900">Ikhtisar Manajemen Jemaah</h2>
            <button onclick="showReportModal()"
                    class="px-4 py-2 bg-primary text-white rounded-lg shadow-md hover:bg-blue-700 transition font-semibold flex items-center">
                <i class="fas fa-download mr-2"></i> Unduh Laporan Jemaah
            </button>
        </div>

        <section class="mb-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-primary">
                    <p class="text-sm font-medium text-neutral uppercase tracking-wide">Total Jemaah</p>
                    <p class="text-3xl font-bold text-gray-900 mt-1">20</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-tracker cursor-pointer"
                    onclick="showKpiDetails('Kemajuan Ritual Harian (Target 70%)', 14, ['P001: 90% Selesai', 'P002: 40% (Tertunda)', 'P003: 100% Selesai', 'P012: 50% (Tertunda)'])">
                    <p class="text-sm font-medium text-neutral uppercase tracking-wide">Ritual Harian (Rata-Rata)</p>
                    <p class="text-3xl font-bold text-gray-900 mt-1 text-tracker">75%</p>
                    <p class="text-xs text-neutral mt-2">Klik untuk progres detail</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-danger cursor-pointer" 
                    onclick="showKpiDetails('Jemaah Berisiko Tinggi', 2, ['Jemaah P002 (Diabetes Kronis)', 'Jemaah P012 (Hipertensi, mobilitas terbatas)'])">
                    <p class="text-sm font-medium text-neutral uppercase tracking-wide">Jemaah Berisiko Tinggi</p>
                    <p class="text-3xl font-bold text-gray-900 mt-1 text-danger">2</p>
                    <p class="text-xs text-neutral mt-2">Klik untuk melihat daftar</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-warning cursor-pointer"
                    onclick="showKpiDetails('Laporan Diajukan (Total 5)', 5, ['Laporan Kematian P007 (TERVERIFIKASI PEMERINTAH)', 'Darurat Medis P002 (Tertunda)', 'Peringatan Lokasi P004 (Ditutup)', 'Pengajuan Dokumen P010 (Disetujui)', 'Perubahan Jadwal Perjalanan P015 (Tertunda)'])">
                    <p class="text-sm font-medium text-neutral uppercase tracking-wide">Laporan Diajukan (Total 5)</p>
                    <p class="text-3xl font-bold text-gray-900 mt-1 text-warning">5</p>
                    <p class="text-xs text-neutral mt-2">Klik untuk melihat status</p>
                </div>
            </div>
        </section>
        
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
            <div class="w-full sm:w-1/3">
                <input type="text" id="search-input" onkeyup="renderPilgrims(1)" placeholder="Cari berdasarkan Nama atau UID..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
            </div>
            <div class="flex space-x-4">
                <select id="filter-risk" onchange="renderPilgrims(1)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    <option value="All">Filter Berdasarkan Risiko: Semua</option>
                    <option value="Low">Risiko Rendah</option>
                    <option value="High">Risiko Tinggi</option>
                </select>
                <select id="filter-status" onchange="renderPilgrims(1)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    <option value="All">Filter Berdasarkan Status: Semua</option>
                    <option value="Active">Aktif</option>
                    <option value="Deceased">Meninggal</option>
                </select>
                <select id="filter-package" onchange="renderPilgrims(1)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    <option value="All">Filter Paket: Semua</option>
                    <option value="Hajj">Haji</option>
                    <option value="Umrah">Umrah</option>
                </select>
            </div>
        </div>

        <section>
            <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-list-ul mr-2 text-primary"></i> Daftar Jemaah
            </h3>
            <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">UID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Nama</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Usia</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Status Perjalanan</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Tingkat Risiko</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-neutral uppercase tracking-wider">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="pilgrim-list" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
                <div id="no-results" class="p-4 text-center text-neutral hidden">Tidak ada jemaah yang cocok dengan filter atau kueri pencarian saat ini.</div>
            </div>

            <div id="pagination-controls" class="flex justify-between items-center mt-4">
                </div>
        </section>
    </main>

    <footer class="bg-primary text-white py-6 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-300">
            <p>&copy; 2025 IBRI-Travel Agency. Ditenagai oleh MabrurX. Semua hak dilindungi.</p>
        </div>
    </footer>

<div id="detailModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-xl max-h-[90vh] overflow-hidden flex flex-col transform transition-all">
        <div class="p-6 overflow-y-auto flex-grow">
            <h3 class="text-2xl font-bold text-primary mb-4 border-b pb-2">Detail Jemaah</h3>
            <div id="modalContent" class="space-y-3 text-gray-700">
                </div>
        </div>
        <div class="bg-gray-50 px-6 py-3 flex justify-end">
            <button onclick="document.getElementById('detailModal').classList.add('hidden')"
                    class="px-4 py-2 bg-neutral text-white rounded-lg hover:bg-gray-700 transition">
                Tutup
            </button>
        </div>
    </div>
</div>

<div id="kpiModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden transform transition-all">
        <div class="p-6">
            <h3 id="kpiModalTitle" class="text-xl font-bold text-primary mb-4 border-b pb-2"></h3>
            <div id="kpiModalContent" class="space-y-2 text-gray-700">
                </div>
        </div>
        <div class="bg-gray-50 px-6 py-3 flex justify-end">
            <button onclick="document.getElementById('kpiModal').classList.add('hidden')"
                    class="px-4 py-2 bg-accent text-gray-900 font-semibold rounded-lg hover:bg-yellow-600 transition">
                OK
            </button>
        </div>
    </div>
</div>

<div id="documentModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col transform transition-all">
        
        <div class="p-4 flex justify-between items-center border-b border-gray-200 no-print-doc bg-light">
            <h3 class="text-xl font-bold text-official flex items-center">
                <i class="fas fa-stamp mr-2 text-secondary"></i> Sertifikat Kematian Resmi
            </h3>
            <button onclick="document.getElementById('documentModal').classList.add('hidden')" class="p-2 text-neutral hover:text-gray-900">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="p-6 flex-grow overflow-y-auto bg-gray-50/50">
            <div id="certPreview" class="border-2 border-dashed border-secondary p-6 bg-certbg rounded-md text-gray-800 shadow-lg">
                <p class="text-center font-bold text-xl mb-1 text-primary">Pemerintah Republik Indonesia</p>
                <p class="text-center text-sm mb-4">Kementerian Agama - Direktorat Jenderal Penyelenggaraan Haji dan Umrah</p>
                <p class="text-3xl text-center text-secondary font-extrabold mb-8">CERTIFICATE OF DEMISE (TERVALIDASI)</p>
                
                <p class="font-medium text-lg mb-4">Telah divalidasi dan dicatat secara resmi oleh Kementerian Agama:</p>
                
                <ul class="list-none ml-4 mt-2 space-y-3 text-base">
                    <li id="certPilgrimName"><i class="fas fa-user-circle mr-2 text-official"></i> Nama Jemaah: <strong class="text-gray-900"></strong></li>
                    <li id="certPilgrimUID"><i class="fas fa-id-card mr-2 text-official"></i> UID: <strong class="text-gray-900"></strong></li>
                    <li id="certAgency"><i class="fas fa-building mr-2 text-official"></i> Agensi Penyelenggara: <strong class="text-gray-900">IBRI-Travel Agency</strong></li>
                    <li id="certValidationDate"><i class="fas fa-calendar-check mr-2 text-official"></i> Tanggal Validasi: <strong class="text-gray-900"></strong></li>
                    <li id="certCause"><i class="fas fa-heartbeat mr-2 text-official"></i> Penyebab Kematian Resmi: <strong class="text-danger"></strong></li>
                </ul>

                <p class="text-center mt-8 text-sm text-neutral italic border-t border-gray-300 pt-4">Dokumen ini memiliki kekuatan hukum setelah ditandatangani oleh pejabat yang berwenang dan tervalidasi di sistem MabrurX Government Track.</p>
            </div>
        </div>
        
        <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg no-print-doc">
            <button onclick="window.print()" 
                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition shadow-md font-semibold flex items-center">
                <i class="fas fa-download mr-2"></i> Unduh PDF
            </button>
            <button onclick="document.getElementById('documentModal').classList.add('hidden')" 
                    class="px-4 py-2 bg-neutral text-white rounded-lg hover:bg-gray-700 transition font-semibold">
                Tutup
            </button>
        </div>
    </div>
</div>

<div id="reportModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-7xl h-[95vh] overflow-hidden transform transition-all flex flex-col">
        <div class="p-4 flex justify-between items-center border-b border-gray-200 no-print bg-light">
            <h3 class="text-xl font-bold text-primary flex items-center"><i class="fas fa-file-invoice mr-2"></i> Pratinjau Laporan Resmi</h3>
            <div class="flex space-x-2">
                 <button onclick="printReport()" 
                         class="px-4 py-2 bg-official text-white font-semibold rounded-lg hover:bg-purple-700 transition flex items-center">
                     <i class="fas fa-download mr-2"></i> Cetak/Simpan PDF
                 </button>
                 <button onclick="document.getElementById('reportModal').classList.add('hidden')" class="p-2 text-neutral hover:text-gray-900">
                     <i class="fas fa-times text-xl"></i>
                 </button>
            </div>
        </div>
        <div class="p-6 flex-grow overflow-y-auto bg-light" id="reportContent">
             </div>
    </div>
</div>

<script>
    // --- Mock Data: 20 Pilgrims for IBRI-Travel (UNCHANGED) ---
    const MOCK_PILGRIMS = [
        { uid: 'P001', name: 'Ahmad Mustofa', age: 45, risk: 'Low', status: 'Active', package: 'Hajj Reguler', package_type: 'Hajj', contact: '08123456789', sugar_level: 'A+', ritual_progress: 90, last_ritual: 'Tawaf Ifadah' },
        { uid: 'P002', name: 'Siti Fatimah Dewi', age: 62, risk: 'High', status: 'Active', package: 'Hajj Khusus', package_type: 'Hajj', medical_note: 'Chronic Diabetes, requires daily checkup.', sugar_level: 'B', ritual_progress: 40, last_ritual: 'Struggling with Sa\'i' },
        { uid: 'P003', name: 'Muhammad Alif', age: 31, risk: 'Low', status: 'Active', package: 'Umrah Basic', package_type: 'Umrah', sugar_level: 'A+', ritual_progress: 100, last_ritual: 'Completed Umrah' },
        { uid: 'P004', name: 'Nurul Huda', age: 50, risk: 'Low', status: 'Active', package: 'Hajj Khusus', package_type: 'Hajj', sugar_level: 'A+', ritual_progress: 75, last_ritual: 'Throwing Pebbles' },
        { uid: 'P005', name: 'Joko Widodo', age: 48, risk: 'Low', status: 'Active', package: 'Hajj Reguler', package_type: 'Hajj', sugar_level: 'A+', ritual_progress: 88, last_ritual: 'Wuquf in Arafah' },
        { uid: 'P006', name: 'Dewi Lestari', age: 39, risk: 'Low', status: 'Active', package: 'Umrah Basic', package_type: 'Umrah', sugar_level: 'A+', ritual_progress: 95, last_ritual: 'Daily Dua/Zikr' },
        // P007 is the deceased pilgrim whose death certificate is available
        { uid: 'P007', name: 'H. Zulkifli', age: 75, risk: 'High', status: 'Deceased', package: 'Hajj Khusus', package_type: 'Hajj', sugar_level: 'B', incident: 'Sudden respiratory failure (Mina). **Government Verified.**', ritual_progress: 100, last_ritual: 'Completed Hajj' },
        { uid: 'P008', name: 'Rina Sari', age: 29, risk: 'Low', status: 'Active', package: 'Hajj Reguler', package_type: 'Hajj', sugar_level: 'A+', ritual_progress: 60, last_ritual: 'Muzdalifah Stay' },
        { uid: 'P009', name: 'Bambang Susilo', age: 55, risk: 'Low', status: 'Active', package: 'Hajj Khusus', package_type: 'Hajj', sugar_level: 'A+', ritual_progress: 80, last_ritual: 'Daily Dua/Zikr' },
        { uid: 'P010', name: 'Sri Mulyani', age: 60, risk: 'Low', status: 'Active', package: 'Hajj Reguler', package_type: 'Hajj', sugar_level: 'A+', ritual_progress: 70, last_ritual: 'Daily Dua/Zikr' },
        { uid: 'P011', name: 'Andi Pratama', age: 33, risk: 'Low', status: 'Active', package: 'Umrah Basic', package_type: 'Umrah', sugar_level: 'A+', ritual_progress: 100, last_ritual: 'Completed Umrah' },
        { uid: 'P012', name: 'Hj. Aminah Yahya', age: 70, risk: 'High', status: 'Active', package: 'Hajj Khusus', package_type: 'Hajj', medical_note: 'Hypertension, mobility limited.', sugar_level: 'B', ritual_progress: 50, last_ritual: 'Daily Dua/Zikr' },
        { uid: 'P013', name: 'Faisal Akbar', age: 42, risk: 'Low', status: 'Active', package: 'Hajj Reguler', package_type: 'Hajj', sugar_level: 'A+', ritual_progress: 92, last_ritual: 'Daily Dua/Zikr' },
        { uid: 'P014', name: 'Eka Putri', age: 25, risk: 'Low', status: 'Active', package: 'Umrah Basic', package_type: 'Umrah', sugar_level: 'A+', ritual_progress: 100, last_ritual: 'Completed Umrah' },
        { uid: 'P015', name: 'Heru Budiman', age: 58, risk: 'Low', status: 'Active', package: 'Hajj Khusus', package_type: 'Hajj', sugar_level: 'A+', ritual_progress: 85, last_ritual: 'Daily Dua/Zikr' },
        { uid: 'P016', name: 'Linda Sari', age: 47, risk: 'Low', status: 'Active', package: 'Hajj Reguler', package_type: 'Hajj', sugar_level: 'A+', ritual_progress: 78, last_ritual: 'Daily Dua/Zikr' },
        { uid: 'P017', name: 'Cahyo Wibowo', age: 36, risk: 'Low', status: 'Active', package: 'Umrah Basic', package_type: 'Umrah', sugar_level: 'A+', ritual_progress: 100, last_ritual: 'Completed Umrah' },
        { uid: 'P018', name: 'Irma Handayani', age: 53, risk: 'Low', status: 'Active', package: 'Hajj Khusus', package_type: 'Hajj', sugar_level: 'A+', ritual_progress: 82, last_ritual: 'Daily Dua/Zikr' },
        { uid: 'P019', name: 'Kusuma Negara', age: 68, risk: 'Low', status: 'Active', package: 'Hajj Reguler', package_type: 'Hajj', sugar_level: 'A+', ritual_progress: 73, last_ritual: 'Daily Dua/Zikr' },
        { uid: 'P020', name: 'Zahra Kemala', age: 41, risk: 'Low', status: 'Active', package: 'Umrah Basic', package_type: 'Umrah', sugar_level: 'A+', ritual_progress: 100, last_ritual: 'Completed Umrah' },
    ];

    const ITEMS_PER_PAGE = 10;
    let currentPage = 1;

    // --- Detail View Simulation Function (UPDATED) ---
    function viewDetails(uid) {
        const data = MOCK_PILGRIMS.find(p => p.uid === uid);
        const modalContent = document.getElementById('modalContent');
        
        if (!data) {
            modalContent.innerHTML = `<p class="text-danger">Kesalahan: Detail Jemaah untuk UID ${uid} tidak ditemukan.</p>`;
        } else {
            const statusColor = data.status === 'Deceased' ? 'text-danger' : 'text-primary';
            const riskColor = data.risk === 'High' ? 'text-danger' : 'text-success';
            const sugarColor = data.sugar_level === 'B' ? 'text-warning' : 'text-success';
            
            // Terjemahkan Teks di Modal
            const statusText = data.status === 'Deceased' ? 'Meninggal' : 'Aktif';
            const riskText = data.risk === 'High' ? 'Tinggi' : 'Rendah';
            
            let ritualStatus = '';
            let ritualColor = data.ritual_progress < 50 ? 'bg-danger' : data.ritual_progress < 80 ? 'bg-warning' : 'bg-success';
            let ritualBarWidth = `${data.ritual_progress}%`;

            if (data.package_type === 'Hajj' || data.package_type === 'Umrah') {
                ritualStatus = `
                    <div class="p-3 mt-4 bg-gray-100 border-l-4 border-tracker">
                        <p class="font-semibold text-tracker flex items-center"><i class="fas fa-route mr-2"></i> Progres Ritual Harian (${data.package_type}):</p>
                        <p class="text-sm text-gray-700">Tingkat Penyelesaian: <span class="font-bold">${data.ritual_progress}%</span></p>
                        <div class="mt-1 w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full ${ritualColor} progress-bar-fill" style="width: ${ritualBarWidth}"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Ritual Terakhir Dilacak: ${data.last_ritual}</p>
                    </div>
                `;
            }

            let html = `
                <p><strong>UID:</strong> <span class="text-gray-900">${data.uid}</span></p>
                <p><strong>Nama:</strong> <span class="text-gray-900">${data.name}</span></p>
                <p><strong>Usia:</strong> ${data.age}</p>
                <p><strong>Status:</strong> <span class="${statusColor} font-semibold">${statusText}</span></p>
                <p><strong>Tingkat Risiko:</strong> <span class="${riskColor} font-semibold">${riskText}</span></p>
                <p><strong>Paket:</strong> ${data.package} (${data.package_type})</p>
                <p><strong><i class="fas fa-syringe mr-1"></i> Kadar Gula (Darat Gula):</strong> <span class="${sugarColor} font-bold">${data.sugar_level}</span></p>
                
                ${ritualStatus}
            `;
            
            // Medical Note Section
            if (data.medical_note || data.sugar_level === 'B') {
                const medicalDetail = data.medical_note 
                    ? `<p class="text-red-600 text-sm">${data.medical_note.replace('Chronic Diabetes, requires daily checkup.', 'Diabetes Kronis, memerlukan pemeriksaan harian.').replace('Hypertension, mobility limited.', 'Hipertensi, mobilitas terbatas.')}</p>`
                    : '';
                const sugarWarning = data.sugar_level === 'B' 
                    ? '<p class="text-sm text-red-600">Catatan: Kadar gula berada pada tingkat B, memerlukan pemantauan intensif.</p>'
                    : '';

                html += `<div class="p-3 mt-4 bg-red-50 border-l-4 border-danger"><p class="font-semibold text-danger"><i class="fas fa-notes-medical mr-1"></i> Catatan/Kondisi Medis:</p>${medicalDetail}${sugarWarning}</div>`;
            }
            
            // Incident/Deceased Section 
            if (data.incident) {
                const incidentText = data.incident
                    .replace('Sudden respiratory failure (Mina). **Government Verified.**', 'Gagal napas mendadak (Mina). **Terverifikasi Pemerintah.**')
                    .replace('Government Verified', 'Terverifikasi Pemerintah');
                
                html += `<div class="p-3 mt-4 bg-gray-100 border-l-4 border-neutral"><p class="font-semibold text-gray-700">Laporan Insiden (Pengajuan Agensi):</p><p class="text-gray-600 text-sm">${incidentText}</p></div>`;
                
                if (data.status === 'Deceased' && data.incident.includes('Government Verified')) {
                    // Cek Jemaah P007 dan masukkan penyebab kematian resmi
                    const causeOfDeath = data.uid === 'P007' 
                        ? 'Gagal napas mendadak (Mina)' 
                        : 'Infark Miokard Akut (Serangan Jantung)'; // Default untuk jemaah lain

                    html += `
                        <div class="mt-4 text-center">
                            <a href="#" onclick="event.preventDefault(); showDocumentModal('${data.uid}', '${data.name}', 'IBRI-Travel Agency', '${causeOfDeath}')" 
                                class="inline-block px-6 py-2 bg-official text-white rounded-lg hover:bg-purple-700 font-semibold transition">
                                <i class="fas fa-file-contract mr-2"></i> Lihat Sertifikat Kematian Pemerintah
                            </a>
                        </div>`;
                } else if (data.status === 'Deceased') {
                    html += `<p class="mt-4 text-center text-warning font-semibold">Laporan Kematian Diajukan. Menunggu verifikasi/penerbitan Pemerintah.</p>`;
                }
            }

            modalContent.innerHTML = html;
        }

        document.getElementById('detailModal').classList.remove('hidden');
    }

    // --- KPI Details Simulation Function (UNCHANGED) ---
    function showKpiDetails(title, count, detailsArray) {
        document.getElementById('kpiModalTitle').textContent = `${title} (${count} item)`;
        
        // Terjemahkan konten detail
        const translatedDetails = detailsArray.map(item => {
             return item
                 .replace('High Risk Pilgrims', 'Jemaah Berisiko Tinggi')
                 .replace('Reports Filed', 'Laporan Diajukan')
                 .replace('Chronic Diabetes', 'Diabetes Kronis')
                 .replace('limited mobility', 'mobilitas terbatas')
                 .replace('Death Report', 'Laporan Kematian')
                 .replace('Medical Emergency', 'Darurat Medis')
                 .replace('Location Alert', 'Peringatan Lokasi')
                 .replace('Document Submission', 'Pengajuan Dokumen')
                 .replace('Travel Itinerary Change', 'Perubahan Jadwal Perjalanan')
                 .replace('(Pending)', '(Tertunda)')
                 .replace('(Closed)', '(Ditutup)')
                 .replace('(Approved)', '(Disetujui)')
                 .replace('(GOV VERIFIED)', '(TERVERIFIKASI PEMERINTAH)')
                 // New ritual tracking translations
                 .replace('P001: 90% Selesai', 'P001: 90% Selesai') 
                 .replace('P002: 40% (Tertunda)', 'P002: 40% (Tertunda)')
                 .replace('P003: 100% Selesai', 'P003: 100% Selesai')
                 .replace('P012: 50% (Tertunda)', 'P012: 50% (Tertunda)')
                 .replace('Completed Hajj', 'Haji Selesai')
                 .replace('Completed Umrah', 'Umrah Selesai')
                 .replace('Struggling with Sa\'i', 'Kesulitan Sa\'i')
                 .replace('Struggling with Tawaf', 'Kesulitan Tawaf');
        });
        
        document.getElementById('kpiModalContent').innerHTML = `
            <p class="text-sm font-semibold text-primary">Ringkasan:</p>
            <ul class="list-disc list-inside space-y-1 text-sm">
                ${translatedDetails.map(item => `<li>${item}</li>`).join('')}
            </ul>
        `;
        document.getElementById('kpiModal').classList.remove('hidden');
    }
    
    // --- Government Document Simulation (CERTIFICATE) (UNCHANGED) ---
    function showDocumentModal(uid, name, agency, cause) {
        // Format tanggal hari ini
        const validationDate = new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
        
        // Update the content of the certificate elements
        document.querySelector('#certPilgrimName strong').textContent = name;
        document.querySelector('#certPilgrimUID strong').textContent = uid;
        document.querySelector('#certAgency strong').textContent = agency;
        document.querySelector('#certValidationDate strong').textContent = validationDate;
        document.querySelector('#certCause strong').textContent = cause;
        
        document.getElementById('detailModal').classList.add('hidden'); // Sembunyikan detail dulu
        document.getElementById('documentModal').classList.remove('hidden');
    }

    // --- Report/Download Functions (UNCHANGED) ---

    // Function to generate and show the report modal
    function showReportModal() {
        const reportContent = document.getElementById('reportContent');
        
        // Use all MOCK_PILGRIMS for the full report, ignoring current dashboard filters/pagination
        const pilgrims = MOCK_PILGRIMS; 
        const agencyName = 'IBRI-Travel Agency';
        const reportDate = new Date().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });

        let tableRows = pilgrims.map(p => `
            <tr>
                <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${p.uid}</td>
                <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-700">${p.name}</td>
                <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-700">${p.age}</td>
                <td class="px-6 py-3 whitespace-nowrap text-sm font-semibold ${p.status === 'Deceased' ? 'text-danger' : 'text-primary'}">${p.status === 'Deceased' ? 'Meninggal' : 'Aktif'}</td>
                <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-700">${p.package}</td>
                <td class="px-6 py-3 whitespace-nowrap text-sm font-semibold ${p.risk === 'High' ? 'text-danger' : 'text-success'}">${p.risk === 'High' ? 'Tinggi' : 'Rendah'}</td>
                <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-700">${p.ritual_progress}%</td>
                <td class="px-6 py-3 text-sm text-gray-700">${p.medical_note ? p.medical_note.substring(0, 20) + '...' : '-'}</td>
            </tr>
        `).join('');

        let reportHTML = `
            <div class="bg-white p-6 shadow-xl rounded-lg mb-6 border-2 border-dashed border-secondary">
                
                <div class="report-header-formal mb-6">
                    <p class="text-center font-bold text-lg mb-1 text-primary">LAPORAN JEMAAH HAJI/UMRAH</p>
                    <p class="text-center text-sm text-neutral">Data Jemaah ${agencyName} per Tanggal ${reportDate}</p>
                </div>

                <div class="space-y-4 mb-6 text-gray-800">
                    <p><strong>Agensi:</strong> ${agencyName}</p>
                    <p><strong>Total Jemaah Tercatat:</strong> ${pilgrims.length}</p>
                    <p><strong>Ringkasan Status:</strong> ${pilgrims.filter(p => p.status === 'Active').length} Aktif, ${pilgrims.filter(p => p.status === 'Deceased').length} Meninggal.</p>
                </div>

                <h4 class="text-lg font-bold text-secondary mb-3">Detail Jemaah (Data Mentah)</h4>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 report-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">UID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Usia</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Paket</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Risiko</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Ritual (%)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Catatan Medis Singkat</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>

                <p class="mt-8 text-center text-xs text-neutral italic border-t border-gray-300 pt-4">Dokumen ini dihasilkan secara otomatis oleh sistem MabrurX pada ${reportDate} dan dapat digunakan untuk keperluan internal agensi.</p>
            </div>
        `;

        reportContent.innerHTML = reportHTML;
        document.getElementById('reportModal').classList.remove('hidden');
    }

    // Print/Download Report Function (UNCHANGED)
    function printReport() {
        // Hide other modals if open
        document.getElementById('detailModal').classList.add('hidden');
        document.getElementById('kpiModal').classList.add('hidden');
        document.getElementById('documentModal').classList.add('hidden');
        
        // Print the report modal content
        window.print(); 
    }

    // --- Pilgrim List Rendering and Pagination (UNCHANGED) ---
    function renderPilgrims(page) {
        currentPage = page;
        const searchInput = document.getElementById('search-input').value.toLowerCase();
        const filterRisk = document.getElementById('filter-risk').value;
        const filterStatus = document.getElementById('filter-status').value;
        const filterPackage = document.getElementById('filter-package').value;

        let filteredPilgrims = MOCK_PILGRIMS.filter(p => {
            const matchesSearch = p.name.toLowerCase().includes(searchInput) || p.uid.toLowerCase().includes(searchInput);
            const matchesRisk = filterRisk === 'All' || p.risk === filterRisk;
            const matchesStatus = filterStatus === 'All' || p.status === filterStatus;
            const matchesPackage = filterPackage === 'All' || p.package_type === filterPackage;
            return matchesSearch && matchesRisk && matchesStatus && matchesPackage;
        });

        const totalPages = Math.ceil(filteredPilgrims.length / ITEMS_PER_PAGE);
        const start = (page - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const pilgrimsOnPage = filteredPilgrims.slice(start, end);

        const pilgrimList = document.getElementById('pilgrim-list');
        const noResults = document.getElementById('no-results');
        pilgrimList.innerHTML = '';

        if (pilgrimsOnPage.length === 0) {
            noResults.classList.remove('hidden');
        } else {
            noResults.classList.add('hidden');
            pilgrimsOnPage.forEach(p => {
                const statusColor = p.status === 'Deceased' ? 'text-danger bg-red-100' : 'text-success bg-green-100';
                const riskColor = p.risk === 'High' ? 'text-danger bg-red-100' : 'text-success bg-green-100';
                const statusText = p.status === 'Deceased' ? 'Meninggal' : 'Aktif';
                const riskText = p.risk === 'High' ? 'Tinggi' : 'Rendah';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.uid}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${p.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${p.age}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${statusText}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${p.package}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${riskColor}">${riskText}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <a href="#" onclick="event.preventDefault(); viewDetails('${p.uid}')" class="text-primary hover:text-blue-700 font-semibold">Lihat Detail</a>
                    </td>
                `;
                pilgrimList.appendChild(row);
            });
        }

        // Render Pagination
        const paginationControls = document.getElementById('pagination-controls');
        paginationControls.innerHTML = '';

        if (totalPages > 1) {
            let paginationHTML = `
                <div>
                    <p class="text-sm text-neutral">
                        Menampilkan <span class="font-medium">${start + 1}</span> sampai <span class="font-medium">${Math.min(end, filteredPilgrims.length)}</span> dari <span class="font-medium">${filteredPilgrims.length}</span> jemaah
                    </p>
                </div>
                <div class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    <button onclick="renderPilgrims(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}
                        class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                        <i class="fas fa-chevron-left"></i>
                    </button>
            `;

            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <button onclick="renderPilgrims(${i})"
                        class="relative inline-flex items-center px-4 py-2 border text-sm font-medium 
                        ${i === currentPage ? 'z-10 bg-primary border-primary text-white' : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'}">
                        ${i}
                    </button>
                `;
            }

            paginationHTML += `
                    <button onclick="renderPilgrims(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}
                        class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            `;
            paginationControls.innerHTML = paginationHTML;
        }
    }

    // Initial render
    document.addEventListener('DOMContentLoaded', () => {
        renderPilgrims(1);
    });
</script>

</body>
</html>
