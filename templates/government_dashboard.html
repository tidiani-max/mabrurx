{% load static %}
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Pemerintah - Portal Validasi MabrurX (Pemerintah)</title>
    <link rel="icon" type="image/png" href="{% static 'rest_framework/img/logo-mabrurx.png' %}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E40AF', 
                        secondary: '#10B981', 
                        accent: '#F59E0B', 
                        neutral: '#6B7280', 
                        light: '#F9FAFB', 
                        danger: '#DC2626', 
                        warning: '#FBBF24', 
                        info: '#3B82F6', 
                        official: '#7C3AED', 
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        #deathCertModal { z-index: 1000; }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-light font-sans antialiased">

    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-primary">Mabrur<span class="text-accent">X</span></h1>
                    <span class="ml-4 text-neutral font-medium">Portal Validasi Kementerian Agama</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="#" onclick="switchTab('overview')" class="text-primary font-semibold">Antrean Validasi</a>
                    <a href="#" onclick="switchTab('agencies')" class="text-neutral hover:text-primary">Pengawasan Agensi</a>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-user-shield text-primary text-xl"></i>
                        <span class="text-neutral">{{ user.full_name|default:"Admin Kementerian" }}</span>
                        <a href="{% url 'api_logout' %}" class="bg-primary text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700">Keluar</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900">Kepatuhan Lisensi dan Catatan Resmi</h2>
            <p class="text-neutral mt-2">Fokus pada validasi kejadian penting dan pemantauan kapasitas agensi berlisensi.</p>
        </div>

        <section id="kpi-section" class="mb-12 relative">
            <div id="loading-kpi" class="loading-overlay hidden">
                <i class="fas fa-spinner animate-spin text-4xl text-primary"></i>
            </div>
            <div id="kpi-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="col-span-4 text-center text-primary"><i class="fas fa-spinner animate-spin mr-2"></i> Memuat Indikator Kinerja Utama...</div>
            </div>
        </section>

        <div id="dashboard-content">
            <section id="tab-overview" class="relative">
                <div id="loading-activity" class="loading-overlay hidden">
                    <i class="fas fa-spinner animate-spin text-4xl text-official"></i>
                </div>
                <h3 class="text-2xl font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-user-times mr-2 text-official"></i> Antrean Validasi Laporan Kematian
                </h3>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <ul id="activity-feed" class="divide-y divide-gray-200">
                        <li class="p-4 text-center text-neutral"><i class="fas fa-spinner animate-spin mr-2"></i> Mengambil laporan validasi dari API...</li>
                    </ul>
                </div>
                <div class="text-center mt-6">
                    <button onclick="alert('Simulating batch processing of pending reports.')" class="px-6 py-2 bg-official text-white rounded-lg hover:bg-purple-800 transition">
                        <i class="fas fa-clipboard-check mr-2"></i> Proses Semua Laporan Tertunda
                    </button>
                </div>
            </section>
            
            <section id="tab-agencies" class="hidden relative">
                <div id="loading-agencies" class="loading-overlay hidden">
                    <i class="fas fa-spinner animate-spin text-4xl text-primary"></i>
                </div>
                <h3 class="text-2xl font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-building mr-2 text-primary"></i> Tinjauan Kapasitas Agensi Berlisensi
                </h3>
                <div class="flex justify-end mb-4">
                     <input type="text" id="agency-search" onkeyup="renderAgencies()" placeholder="Cari agensi..."
                             class="w-1/3 px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                </div>
                <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Nama Agensi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Jemaah (Haji)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Jemaah (Umrah)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Staf Agensi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Skor Kepatuhan</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-neutral uppercase tracking-wider">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="agency-list" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="6" class="p-4 text-center text-neutral"><i class="fas fa-spinner animate-spin mr-2"></i> Mengambil data agensi...</td></tr>
                        </tbody>
                    </table>
                     <div id="no-agency-results" class="p-4 text-center text-neutral hidden">Tidak ada agensi yang cocok dengan kueri pencarian.</div>
                </div>
            </section>
        </div>

    </main>

    <footer class="bg-gray-900 text-white py-6 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm text-neutral">
            <p>&copy; 2025 MabrurX. Portal Pemerintah. Semua hak dilindungi. (Mode Simulasi API)</p>
        </div>
    </footer>

    <div id="detailModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg w-full max-w-lg shadow-xl transform transition-all">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-file-alt mr-2 text-official"></i> Detail Laporan Jemaah
                </h3>
                <div id="modalContent" class="space-y-2 text-gray-700">
                    <p>Memuat data...</p>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                <div id="validationActions" class="flex items-center">
                    </div>
                <button onclick="document.getElementById('detailModal').classList.add('hidden')" 
                        class="px-4 py-2 bg-neutral text-white rounded-lg hover:bg-gray-700 transition">
                    Tutup
                </button>
            </div>
        </div>
    </div>
    
    <div id="deathCertModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg w-full max-w-2xl shadow-xl transform transition-all">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-stamp mr-2 text-secondary"></i> Sertifikat Kematian Resmi
                </h3>
                <div id="certPreview" class="border p-4 bg-green-50 rounded-md text-gray-800">
                    <p class="text-center font-bold text-lg mb-2">Pemerintah Republik Indonesia</p>
                    <p class="text-center text-xs mb-4">Kementerian Agama - Direktorat Jenderal Penyelenggaraan Haji dan Umrah</p>
                    <p class="text-2xl text-center text-secondary font-extrabold mb-6">CERTIFICATE OF DEMISE (TERVALIDASI)</p>
                    <p>Telah divalidasi dan dicatat secara resmi oleh Kementerian Agama:</p>
                    <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                        <li id="certPilgrimName">Nama Jemaah: </li>
                        <li id="certPilgrimUID">UID: </li>
                        <li id="certAgency">Agensi Penyelenggara: </li>
                        <li>Tanggal Validasi: **{{ "now"|date:"d M Y" }}** (Simulasi)</li>
                    </ul>
                    <p class="text-center mt-6 text-sm text-neutral">Dokumen ini memiliki kekuatan hukum setelah ditandatangani oleh pejabat yang berwenang.</p>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg">
                <button onclick="alert('Simulasi: Mendownload dokumen PDF...') && document.getElementById('deathCertModal').classList.add('hidden')"
                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-download mr-1"></i> Unduh PDF
                </button>
                <button onclick="document.getElementById('deathCertModal').classList.add('hidden')" 
                        class="px-4 py-2 bg-neutral text-white rounded-lg hover:bg-gray-700 transition">
                    Tutup
                </button>
            </div>
        </div>
    </div>
    
    <div id="agencyDetailModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg w-full max-w-lg shadow-xl p-6">
             <h3 class="text-xl font-bold text-gray-900 mb-4">Detail Agensi</h3>
             <p>Detail agensi akan muncul di sini.</p>
             <button onclick="document.getElementById('agencyDetailModal').classList.add('hidden')" class="mt-4 px-4 py-2 bg-neutral text-white rounded-lg">Tutup</button>
        </div>
    </div>


<script>
    // --- API Configuration ---
    // Assumes 'api_government_data' and 'agencies_list_api' are defined in Django urls
    const API_URL = "{% url 'api_government_data' %}";
    const AGENCIES_API_URL = "{% url 'agencies_list_api' %}"; 

    // --- Back-End Simulation (MOCK DATA) ---
    let SERVER_DATA = {
        agencies: [
            { id: 'A001', name: 'IBRI-Travel', hajj: 1200, umrah: 800, staff: 20, reportsFiled: 8, reportsOngoing: 1, complianceScore: 95, contact: 'admin@IBRI-Travel.com', license: 'L001-Hajj', ongoingReports: ['P0004: Lost baggage compensation'], highRiskCount: 15 },
            { id: 'A002', name: 'PT Amanah Tour', hajj: 2500, umrah: 1000, staff: 40, reportsFiled: 12, reportsOngoing: 3, complianceScore: 88, contact: 'support@amanahtour.id', license: 'L002-Umrah', ongoingReports: ['P0001: Death verification pending', 'P0012: Food poisoning case', 'A002-C01: Contract dispute'], highRiskCount: 25 },
            { id: 'A004', name: 'PT Travel Nakal', hajj: 50, umrah: 0, staff: 2, reportsFiled: 15, reportsOngoing: 6, complianceScore: 45, contact: 'abuse@travelnakal.net', license: 'L004-PENDING', ongoingReports: ['P0005: Deceased (Pending Gov. Approval)', 'A004-V03: Overcharging investigation', 'P0020: Pilgrim missing'], highRiskCount: 5 },
        ],
        queue: [
            { uid: 'P0001', name: 'H. Abdullah Rahman', agency: 'PT Amanah Tour', report: 'Death Report Filed (Requires Gov. Validation)', type: 'deceased', status: 'Pending Validation' },
            { uid: 'P0005', name: 'Nur Hidayah', agency: 'PT Travel Nakal', report: 'Death Report Filed (Agency Under Review)', type: 'deceased', status: 'Pending Validation' },
            { uid: 'P0002', name: 'Siti Fatimah Dewi', agency: 'Cahaya Abadi', report: 'Medical Alert: High Risk Case Monitoring', type: 'high_risk', status: 'Active Monitoring' },
        ],
        pilgrims_dossiers: {
            'P0001': { name: 'H. Abdullah Rahman', age: 68, risk: 'High (Deceased)', agency: 'PT Amanah Tour', location: 'Mina Camp', incident: 'Sudden cardiac arrest in Mina.' },
            'P0005': { name: 'Nur Hidayah', age: 72, risk: 'High (Deceased)', agency: 'PT Travel Nakal', location: 'Hotel Makkah', incident: 'Fall and serious injury.' },
            'P0002': { name: 'Siti Fatimah Dewi', age: 55, risk: 'High', agency: 'Cahaya Abadi', location: 'Hotel Al-Hijra', medical: 'Chronic Diabetes, Hypertension.' },
        }
    };
    
    // --- API FUNCTIONS (Simulated Fetch) ---
    const API_DELAY_MS = 800;

    const getDashboardData = () => {
        document.getElementById('loading-kpi').classList.remove('hidden');
        document.getElementById('loading-activity').classList.remove('hidden');
        
        return new Promise(resolve => setTimeout(() => {
            document.getElementById('loading-kpi').classList.add('hidden');
            document.getElementById('loading-activity').classList.add('hidden');
            // Mocking the DRF response structure based on government_dashboard_api
            resolve({
                metrics: {
                    total_pilgrims: 12000, 
                    total_agencies: 10,
                    high_risk_pilgrims_pct: 0.05, 
                    death_reports_count: SERVER_DATA.queue.filter(q => q.type === 'deceased' && q.status === 'Pending Validation').length,
                    total_staff: 250,
                    agencies_under_review: 1, 
                },
                recent_activities: [
                    // Filter activities to reflect current queue status
                    ...SERVER_DATA.queue.map(item => ({
                        type: item.type === 'deceased' ? "DEATH_REPORT" : "HIGH_RISK", 
                        message: item.report, 
                        context: `Agency: ${item.agency} | Status: ${item.status}`, 
                        pilgrim_uid: item.uid, 
                        time_ago: item.status.includes('Pending') ? "5 minutes ago" : "1 day ago"
                    }))
                ],
            });
        }, API_DELAY_MS));
    };

    const getAgencyData = () => {
        document.getElementById('loading-agencies').classList.remove('hidden');
        return new Promise(resolve => setTimeout(() => {
            document.getElementById('loading-agencies').classList.add('hidden');
            resolve(SERVER_DATA.agencies);
        }, API_DELAY_MS));
    };
    
    const getPilgrimDossier = (uid) => new Promise(resolve => setTimeout(() => resolve(SERVER_DATA.pilgrims_dossiers[uid]), API_DELAY_MS / 2));
    
    const processDeathValidation = (uid, action) => {
        return new Promise(resolve => {
            setTimeout(() => {
                let queueItem = SERVER_DATA.queue.find(item => item.uid === uid);
                
                if (!queueItem) {
                    return resolve({ status: 'error', message: 'Item not found in queue.' });
                }

                if (action === 'validate') {
                    queueItem.status = 'Validated & Issued';
                    queueItem.report = 'Death Certificate Issued';
                    resolve({ status: 'success', message: `Official Death Certificate Issued for ${queueItem.name} (${uid}).` });
                } else if (action === 'reject') {
                    // Update status to rejected but keep in the queue for visual change
                    queueItem.status = 'Rejected (Requires Agency Resubmit)'; 
                    resolve({ status: 'rejected', message: `Report Rejected for ${uid}. Requires agency follow-up.` });
                } else {
                    resolve({ status: 'error', message: 'Invalid action.' });
                }
            }, API_DELAY_MS);
        });
    };

    // --- Tab Switching Logic ---
    async function switchTab(tabId) {
        document.querySelector('a.text-primary').classList.remove('text-primary', 'font-semibold');
        document.querySelector('a.text-neutral.hover\\:text-primary').classList.remove('text-primary', 'font-semibold');
        
        document.getElementById('tab-overview').classList.add('hidden');
        document.getElementById('tab-agencies').classList.add('hidden');
        
        document.getElementById(`tab-${tabId}`).classList.remove('hidden');
        
        // Highlight the clicked tab (re-select it by text content for simplicity)
        const tabLink = Array.from(document.querySelectorAll('nav a')).find(a => a.getAttribute('onclick').includes(`'${tabId}'`));
        if(tabLink) {
             tabLink.classList.remove('text-neutral');
             tabLink.classList.add('text-primary', 'font-semibold');
        }


        if (tabId === 'agencies') {
            await renderAgencies();
        } else {
            await renderKPIs();
            await renderActivityFeed();
        }
    }
    
    // --- KPI Rendering ---
    async function renderKPIs() {
        const data = await getDashboardData();
        const metrics = data.metrics;

        const DEATH_QUEUE = metrics.death_reports_count;
        const AGENCIES_UNDER_REVIEW = metrics.agencies_under_review || 1; 
        const TOTAL_STAFF = metrics.total_staff || 250; 

        const kpiHtml = `
            <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-secondary">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-neutral uppercase tracking-wide">Total Jemaah (Tervalidasi)</p>
                        <p id="kpi-total-pilgrims" class="text-3xl font-bold text-gray-900 mt-1">${metrics.total_pilgrims.toLocaleString()}</p>
                    </div>
                    <div class="p-3 bg-secondary/10 rounded-full">
                        <i class="fas fa-users text-2xl text-secondary"></i>
                    </div>
                </div>
                <p class="text-sm text-neutral mt-2">${(metrics.high_risk_pilgrims_pct * 100).toFixed(1)}% Jemaah Risiko Tinggi</p>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-official cursor-pointer" onclick="switchTab('overview')">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-neutral uppercase tracking-wide">Antrean Validasi Kematian</p>
                        <p id="kpi-death-queue" class="text-3xl font-bold text-official mt-1">${DEATH_QUEUE}</p>
                    </div>
                    <div class="p-3 bg-official/10 rounded-full">
                        <i class="fas fa-crosshairs text-2xl text-official"></i>
                    </div>
                </div>
                <p class="text-sm text-neutral mt-2">Laporan Menunggu Sertifikat Resmi</p>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-info">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-neutral uppercase tracking-wide">Total Staf Agensi</p>
                        <p id="kpi-total-staff" class="text-3xl font-bold text-gray-900 mt-1">${TOTAL_STAFF}</p>
                    </div>
                    <div class="p-3 bg-info/10 rounded-full">
                        <i class="fas fa-user-tie text-2xl text-info"></i>
                    </div>
                </div>
                <p class="text-sm text-neutral mt-2">${metrics.total_agencies} Agensi Aktif</p>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-danger">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-neutral uppercase tracking-wide">Agensi Dalam Peninjauan</p>
                        <p id="kpi-agencies-review" class="text-3xl font-bold text-danger mt-1">${AGENCIES_UNDER_REVIEW}</p>
                    </div>
                    <div class="p-3 bg-danger/10 rounded-full">
                        <i class="fas fa-exclamation-triangle text-2xl text-danger"></i>
                    </div>
                </div>
                <p class="text-sm text-neutral mt-2">Di Bawah 70% Kepatuhan (Simulasi)</p>
            </div>
        `;
        document.getElementById('kpi-cards').innerHTML = kpiHtml;
    }


    // --- Pilgrim Detail View (Fixing the modal logic) ---
    async function viewPilgrimDetails(uid, type) {
        document.getElementById('detailModal').classList.remove('hidden'); // Show modal frame immediately
        const modalContent = document.getElementById('modalContent');
        const validationActions = document.getElementById('validationActions');

        // Reset content while loading
        modalContent.innerHTML = '<p class="text-center text-primary"><i class="fas fa-spinner animate-spin mr-2"></i> Mengambil data...</p>';
        validationActions.innerHTML = '';
        
        const data = await getPilgrimDossier(uid);
        const queueItem = SERVER_DATA.queue.find(item => item.uid === uid) || {};

        if (!data) {
            modalContent.innerHTML = '<p class="text-danger font-semibold">Error: Pilgrim dossier not found.</p>';
            return;
        }

        const isPending = queueItem.status === 'Pending Validation';
        const isValidated = queueItem.status && queueItem.status.includes('Validated');
        
        const riskColor = isValidated ? 'text-secondary' : isPending ? 'text-danger' : 'text-warning';
        let html = `
            <p><strong>UID:</strong> ${uid}</p>
            <p><strong>Nama:</strong> ${data.name}</p>
            <p><strong>Usia:</strong> ${data.age || 'N/A'}</p>
            <p><strong>Agensi:</strong> <span class="font-semibold text-primary">${data.agency || 'N/A'}</span></p>
            <p><strong>Status Validasi:</strong> <span class="font-bold ${riskColor}">${queueItem.status || 'N/A'}</span></p>
        `;
        
        if (data.incident) {
            html += `<div class="mt-3 p-3 bg-red-100 border-l-4 border-danger"><strong>Laporan Agensi:</strong> ${data.incident}</div>`;
        } else if (data.medical) {
             html += `<div class="mt-3 p-3 bg-yellow-100 border-l-4 border-warning"><strong>Catatan Medis:</strong> ${data.medical}</div>`;
        }
        
        modalContent.innerHTML = html;

        // Validation Buttons Logic
        if (type === 'deceased' && isPending) {
            validationActions.innerHTML = `
                <button id="validateBtn" onclick="simulateValidation('${uid}', '${data.name}', '${data.agency}', 'validate')" 
                        class="px-4 py-2 bg-official text-white rounded-lg hover:bg-purple-800 transition mr-2">
                    <i class="fas fa-certificate mr-1"></i> Terbitkan Sertifikat Kematian Resmi
                </button>
                <button id="rejectBtn" onclick="simulateValidation('${uid}', '${data.name}', '${data.agency}', 'reject')" 
                        class="px-4 py-2 bg-danger text-white rounded-lg hover:bg-red-700 transition">
                    <i class="fas fa-times-circle mr-1"></i> Tolak Laporan
                </button>
            `;
        } else if (isValidated) {
             validationActions.innerHTML = `
                <button onclick="showDeathCertModal('${uid}', '${data.name}', '${data.agency}')" 
                        class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-green-700 transition">
                    <i class="fas fa-file-pdf mr-1"></i> Lihat Sertifikat Tervalidasi
                </button>
            `;
        } else {
            validationActions.innerHTML = `<p class="text-sm text-neutral">Tidak ada validasi catatan resmi yang diperlukan saat ini.</p>`;
        }
    }
    
    // --- Validation Handler (The missing logic) ---
    async function simulateValidation(uid, name, agency, action) {
        if (!confirm(`Apakah Anda yakin ingin ${action === 'validate' ? 'MENGESAHKAN (Validasi)' : 'MENOLAK (Tolak)'} laporan untuk jemaah ${name} (${uid})? Tindakan ini akan memperbarui catatan resmi.`)) {
            return;
        }

        const validateBtn = document.getElementById('validateBtn');
        const rejectBtn = document.getElementById('rejectBtn');

        // Show loading state on buttons
        if (validateBtn) validateBtn.disabled = true;
        if (rejectBtn) rejectBtn.disabled = true;
        const originalText = action === 'validate' ? validateBtn.innerHTML : rejectBtn.innerHTML;
        const targetBtn = action === 'validate' ? validateBtn : rejectBtn;
        if (targetBtn) targetBtn.innerHTML = '<i class="fas fa-spinner animate-spin"></i> Memproses...';


        const result = await processDeathValidation(uid, action); 

        document.getElementById('detailModal').classList.add('hidden');
        
        if (result.status === 'success') {
            alert(`SUKSES: ${result.message}`);
            await renderKPIs();
            await renderActivityFeed();
            showDeathCertModal(uid, name, agency);
        } else if (result.status === 'rejected') {
            alert(`DITOLAK: ${result.message}`);
            await renderKPIs();
            await renderActivityFeed();
        } else {
            alert(`GALAT: ${result.message}`);
        }

        // Reset buttons if needed (though modal is hidden)
        if (validateBtn) validateBtn.disabled = false;
        if (rejectBtn) rejectBtn.disabled = false;
    }


    // --- Certificate Preview (The missing function) ---
    function showDeathCertModal(uid, name, agency) {
        // Fill the simulated certificate details
        document.getElementById('certPilgrimName').innerHTML = `Nama Jemaah: <strong>${name}</strong>`;
        document.getElementById('certPilgrimUID').innerHTML = `UID: <strong>${uid}</strong>`;
        document.getElementById('certAgency').innerHTML = `Agensi Penyelenggara: <strong>${agency}</strong>`;
        
        // Show the certificate modal
        document.getElementById('deathCertModal').classList.remove('hidden');
    }

    // --- Activity Feed Rendering ---
    async function renderActivityFeed() {
        const activityFeed = document.getElementById('activity-feed');
        activityFeed.innerHTML = `<li class="p-4 text-center text-primary"><i class="fas fa-spinner animate-spin mr-2"></i> Mengambil laporan validasi dari API...</li>`;

        const data = await getDashboardData();
        const activities = data.recent_activities.filter(a => a.type === "DEATH_REPORT" && !a.context.includes("Validated")).slice(0, 10); // Show only pending/recent death reports
        
        const activityHTML = activities.map(activity => {
            const isDeceased = activity.type === 'DEATH_REPORT';
            const status = activity.context.split('Status: ')[1] || 'Unknown';
            const isPending = status.includes('Pending');

            const iconClass = isDeceased ? 'fas fa-skull text-danger' : 'fas fa-heartbeat text-warning';
            const actionText = isPending ? 'Validasi Kematian' : 'Lihat Dossier';

            return `
                <li class="p-4 hover:bg-gray-50 transition-colors ${isPending ? 'bg-red-50' : ''}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="${iconClass} text-lg"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">${activity.message.replace('**', '').replace('**', '')} <span class="text-xs text-official font-bold">(${status})</span></p>
                                <p class="text-sm text-neutral">${activity.context} | Dilaporkan: ${activity.time_ago}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <a href="#" 
                               onclick="event.preventDefault(); viewPilgrimDetails('${activity.pilgrim_uid}', '${isDeceased ? 'deceased' : 'high_risk'}')"
                               class="text-sm text-official hover:underline">
                                ${actionText}
                            </a>
                        </div>
                    </div>
                </li>
            `;
        }).join('');

        activityFeed.innerHTML = activityHTML.length > 0 
            ? activityHTML 
            : '<li class="p-4 text-center text-secondary font-semibold"><i class="fas fa-check-circle mr-2"></i> Antrean validasi kosong.</li>';
    }
    
    // --- Agency Rendering (Placeholder) ---
    async function renderAgencies() {
        const agencyList = document.getElementById('agency-list');
        const search = document.getElementById('agency-search').value.toLowerCase();
        
        const agencies = await getAgencyData(); // Fetches all mock data
        
        const filteredAgencies = agencies.filter(a => a.name.toLowerCase().includes(search));

        if (filteredAgencies.length === 0) {
            agencyList.innerHTML = '';
            document.getElementById('no-agency-results').classList.remove('hidden');
            return;
        } else {
             document.getElementById('no-agency-results').classList.add('hidden');
        }

        const agencyHTML = filteredAgencies.map(agency => `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${agency.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral">${agency.hajj.toLocaleString()}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral">${agency.umrah.toLocaleString()}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral">${agency.staff}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${agency.complianceScore < 70 ? 'text-danger' : 'text-secondary'}">${agency.complianceScore}%</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <a href="#" onclick="event.preventDefault(); viewAgencyDetails('${agency.id}')" class="text-primary hover:text-blue-700">Lihat Detail</a>
                </td>
            </tr>
        `).join('');
        
        agencyList.innerHTML = agencyHTML;
    }
    
    function viewAgencyDetails(id) {
        alert(`Simulasi: Membuka detail Agensi ID: ${id}`);
        // document.getElementById('agencyDetailModal').classList.remove('hidden'); 
    }


    // --- Execution on Load ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Run initial data load and rendering
        await renderKPIs();
        await renderActivityFeed();
        
        // Expose functions globally for HTML inline events
        window.switchTab = switchTab;
        window.simulateValidation = simulateValidation;
        window.showDeathCertModal = showDeathCertModal;
        window.renderAgencies = renderAgencies;
        window.viewPilgrimDetails = viewPilgrimDetails;
        window.viewAgencyDetails = viewAgencyDetails;
    });
</script>
</body>
</html>
